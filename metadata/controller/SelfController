{
    "type": "Ext.app.Controller",
    "reference": {
        "name": "items",
        "type": "array"
    },
    "codeClass": null,
    "userConfig": {
        "designer|userClassName": "SelfController"
    },
    "designerId": "408f57d8-a79a-4d08-87b1-d69480d1ba10",
    "cn": [
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "mainpanel #self #selfMenuList",
                "designer|targetType": "Ext.dataview.List",
                "fn": "onListItemSingletap",
                "implHandler": [
                    "// 获取点击的内容id,进行不同的响应操作\r",
                    "var id = record.data.id;\r",
                    "\r",
                    "var selfNavigateView = this.getSelfNavigateView();\r",
                    "\r",
                    "if(id === 'withdrawal'){ //提现\r",
                    "    var accountBalance = dataview.getItemAt(4);\r",
                    "    var balance = accountBalance.getRecord().data.name; //未提现金额\r",
                    "    balance = balance.substring(4, balance.length-1);\r",
                    "\r",
                    "    selfNavigateView.push({\r",
                    "        xtype: 'withdrawal',\r",
                    "        title: record.data.name\r",
                    "    });\r",
                    "\r",
                    "    var withdrawal = this.getWithdrawal();\r",
                    "    var balanceLabel = withdrawal.getComponent(\"labelContainer\").getComponent(\"balance\");\r",
                    "    balanceLabel.setHtml(\"<font color='red'>\"+balance+\"</font>元\");\r",
                    "    balanceLabel.setData(balance);\r",
                    "\r",
                    "} else if(id === 'withdrawalHistory'){ //提现历史\r",
                    "    selfNavigateView.push({\r",
                    "        xtype: 'withdrawalhistory',\r",
                    "        title: record.data.name\r",
                    "    });\r",
                    "    var withdrawalHistoryStore = Ext.getStore('WithdrawalHistoryStore');\r",
                    "    withdrawalHistoryStore.load();\r",
                    "\r",
                    "} else if(id === 'myinfo'){ // 我的资料\r",
                    "    selfNavigateView.push({\r",
                    "        xtype: 'myinfo',\r",
                    "        title: record.data.name\r",
                    "    });\r",
                    "\r",
                    "} else if(id === 'mypassword'){ // 修改密码\r",
                    "    selfNavigateView.push({\r",
                    "        xtype: 'mypassword',\r",
                    "        title: record.data.name\r",
                    "    });\r",
                    "\r",
                    "} else if(id === 'logout'){ // 退出操作\r",
                    "    Ext.Msg.show({\r",
                    "        title: '提示',\r",
                    "        message: '确定要退出？',\r",
                    "        promptConfig: false,\r",
                    "        buttons: [\r",
                    "            {text: '否',  itemId: 'no'},\r",
                    "            {text: '是', itemId: 'yes', ui: 'action'}\r",
                    "        ],\r",
                    "        scope: this,\r",
                    "        fn: function(btn) {\r",
                    "            if(btn === 'yes'){\r",
                    "                // 清除保存的用户信息\r",
                    "                var dataStore = Ext.getStore('UserStore');\r",
                    "                dataStore.load();\r",
                    "                var user = dataStore.getAt(0);\r",
                    "                if (user) {\r",
                    "                    user.erase();\r",
                    "                }\r",
                    "\r",
                    "                var loginPanel = Ext.createByAlias('widget.loginform');\r",
                    "                var mainpanel = this.getMainPanel();\r",
                    "                Ext.Viewport.add(loginPanel);\r",
                    "                loginPanel.show();\r",
                    "                mainpanel.hide();\r",
                    "                this.getTaskNavigateView().reset();\r",
                    "                this.getSharedNavigateView().reset();\r",
                    "            }\r",
                    "        }\r",
                    "    });\r",
                    "\r",
                    "}"
                ],
                "name": "itemsingletap"
            },
            "designerId": "f8fb78b2-89c6-48bb-a24b-2bc73c982d02"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "mainPanel",
                "selector": "mainpanel"
            },
            "designerId": "c9652897-be40-495a-86e7-095005fa4291"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "selfNavigateView",
                "selector": "mainpanel #selfNavigateView"
            },
            "designerId": "1f122cd7-7e05-4c78-a61e-d18d73a8d65b"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "taskNavigateView",
                "selector": "mainpanel #taskNavigateView"
            },
            "designerId": "5630a00c-5331-45dd-88ae-067920f8f138"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "sharedNavigateView",
                "selector": "mainpanel #sharedNavigateView"
            },
            "designerId": "edc17d14-8d87-4bf3-88bd-430572f7afbf"
        },
        {
            "type": "controllerref",
            "reference": {
                "name": "items",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "ref": "withdrawal",
                "selector": "withdrawal"
            },
            "designerId": "efb35807-e97d-43be-b180-f0c42dba8fff"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "withdrawal #claimBtn",
                "designer|targetType": "Ext.Button",
                "fn": "onClaimBtnTap",
                "implHandler": [
                    "var withdrawal = this.getWithdrawal();\r",
                    "var claimAmount = withdrawal.getComponent(\"claimAmount\").getValue();\r",
                    "var reg = /^[0-9]+(.[0-9]{1,2})?$/;\r",
                    "if(!reg.test(claimAmount)){\r",
                    "    Ext.Msg.alert(\"提示\", '请输入正确的金额');\r",
                    "    return;\r",
                    "}\r",
                    "\r",
                    "var balanceLabel = withdrawal.getComponent(\"labelContainer\").getComponent(\"balance\");\r",
                    "var balance = balanceLabel.getData();\r",
                    "if(claimAmount > balance){\r",
                    "    Ext.Msg.alert(\"提示\", '提现金额超出余额');\r",
                    "    return;\r",
                    "}\r",
                    "\r",
                    "button.setDisabled(true);\r",
                    "\r",
                    "var successCallback = function(resp, ops) {\r",
                    "    if(resp.responseText === 'true') {\r",
                    "        var selfMenuStore = Ext.getStore('SelfMenuStore');\r",
                    "        selfMenuStore.load();\r",
                    "        Ext.Msg.alert(\"提示\", '提现成功');\r",
                    "\r",
                    "        balance = balance-claimAmount;\r",
                    "        balanceLabel.setHtml(\"<font color='red'>\"+balance+\"</font>元\");\r",
                    "        balanceLabel.setData(balance);\r",
                    "        withdrawal.getComponent(\"claimAmount\").setValue('');\r",
                    "    } else {\r",
                    "        Ext.Msg.alert(\"提示\", '系统繁忙，请稍后重试');\r",
                    "    }\r",
                    "\r",
                    "    button.setDisabled(false);\r",
                    "};\r",
                    "\r",
                    "var failureCallback = function(resp, ops) {\r",
                    "    button.setDisabled(false);\r",
                    "    Ext.Msg.alert(\"提示\", '网络连接超时');\r",
                    "};\r",
                    "\r",
                    "Ext.Ajax.request({\r",
                    "    url: \"/weixin/mobile/self/withdrawal.htm\",\r",
                    "    params: {\"amount\": claimAmount},\r",
                    "    success: successCallback,\r",
                    "    failure: failureCallback\r",
                    "});\r",
                    "\r",
                    "\r",
                    ""
                ],
                "name": "tap"
            },
            "designerId": "384ce53d-a27c-4eff-92f2-7895b798d91d"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "myinfo #infoBtn",
                "designer|targetType": "Ext.Button",
                "fn": "onInfoBtnTap",
                "implHandler": [
                    "var form = button.up('formpanel'),\t\t\t// Register form\r",
                    "    values = form.getValues();\t\t\t\t// Form values\r",
                    "\r",
                    "if(values.wechatName === '') {\r",
                    "    Ext.Msg.alert(\"提示\", '微信号不能为空');\r",
                    "    return;\r",
                    "}\r",
                    "\r",
                    "button.setDisabled(true);\r",
                    "\r",
                    "// 保存成功\r",
                    "var successCallback = function(resp, ops) {\r",
                    "    var registerResult = resp.responseText;\r",
                    "    if(registerResult === 'success') {\r",
                    "        var dataStore = Ext.getStore('UserStore');\r",
                    "        dataStore.load();\r",
                    "        var user = dataStore.getAt(0);\r",
                    "        user.data.wechatName = values.wechatName;\r",
                    "        user.data.gender = values.gender;\r",
                    "        user.data.age = values.age;\r",
                    "        user.data.provinceId = values.province;\r",
                    "        user.data.cityId = values.city;\r",
                    "        user.data.positionId = values.position;\r",
                    "        user.save();\r",
                    "\r",
                    "        Ext.Msg.alert(\"提示\", '保存成功');\r",
                    "    } else {\r",
                    "        Ext.Msg.alert(\"提示\", '保存失败，请重试');\r",
                    "    }\r",
                    "    button.setDisabled(false);\r",
                    "\r",
                    "};\r",
                    "\r",
                    "// 网络错误\r",
                    "var failureCallback = function(resp, ops) {\r",
                    "    button.setDisabled(false);\r",
                    "    Ext.Msg.alert(\"提示\", '网络连接超时');\r",
                    "};\r",
                    "\r",
                    "Ext.Ajax.request({\r",
                    "    url: \"/weixin/mobile/self/saveInfo.htm\",\r",
                    "    params: values,\r",
                    "    success: successCallback,\r",
                    "    failure: failureCallback\r",
                    "});"
                ],
                "name": "tap"
            },
            "designerId": "2cb21edb-1a3c-42c9-8115-6298ecef6f64"
        },
        {
            "type": "controlleraction",
            "reference": {
                "name": "listeners",
                "type": "array"
            },
            "codeClass": null,
            "userConfig": {
                "designer|controlQuery": "mypassword #passBtn",
                "designer|targetType": "Ext.Button",
                "fn": "onButtonTap",
                "implHandler": [
                    "var form = button.up('formpanel'),\r",
                    "    values = form.getValues(),\r",
                    "    user = mobile.view.MyUtils.getUserInfo();\r",
                    "\r",
                    "if(values.oldPassword === '') {\r",
                    "    Ext.Msg.alert(\"提示\", '旧密码不能为空');\r",
                    "    return;\r",
                    "} else if(values.newPassword === '') {\r",
                    "    Ext.Msg.alert(\"提示\", '新密码不能为空');\r",
                    "    return;\r",
                    "} else if(values.newPassword.length>16 || values.newPassword.length<6) {\r",
                    "    Ext.Msg.alert(\"提示\", '密码长度为6到16个字符，请确认');\r",
                    "    return;\r",
                    "} else if(values.confirmNewPass === '') {\r",
                    "    Ext.Msg.alert(\"提示\", '确认密码不能为空');\r",
                    "    return;\r",
                    "} else if(values.newPassword !== values.confirmNewPass) {\r",
                    "    Ext.Msg.alert(\"提示\", '密码不一致');\r",
                    "    return;\r",
                    "} else if(values.oldPassword !== user.password) {\r",
                    "    Ext.Msg.alert(\"提示\", '旧密码不正确');\r",
                    "    return;\r",
                    "}\r",
                    "\r",
                    "button.setDisabled(true);\r",
                    "\r",
                    "var successCallback = function(resp, ops) {\r",
                    "    var registerResult = resp.responseText;\r",
                    "    if(registerResult === 'success') {\r",
                    "        form.reset();\r",
                    "        var dataStore = Ext.getStore('UserStore');\r",
                    "        dataStore.load();\r",
                    "        var user = dataStore.getAt(0);\r",
                    "        user.data.password = values.newPassword;\r",
                    "        user.save();\r",
                    "\r",
                    "        Ext.Msg.alert(\"提示\", '修改成功');\r",
                    "    } else {\r",
                    "        Ext.Msg.alert(\"提示\", '修改失败，请重试');\r",
                    "    }\r",
                    "    button.setDisabled(false);\r",
                    "\r",
                    "};\r",
                    "\r",
                    "var failureCallback = function(resp, ops) {\r",
                    "    button.setDisabled(false);\r",
                    "    Ext.Msg.alert(\"提示\", '网络连接超时');\r",
                    "};\r",
                    "\r",
                    "Ext.Ajax.request({\r",
                    "    url: \"/weixin/mobile/self/savePassword.htm\",\r",
                    "    params: values,\r",
                    "    success: successCallback,\r",
                    "    failure: failureCallback\r",
                    "});"
                ],
                "name": "tap"
            },
            "designerId": "4d94eb93-6590-44f1-8a3b-498ed9667042"
        }
    ]
}